<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare WebRTC Multi-User</title>
</head>
<body>
    <h1>Cloudflare WebRTC Multi-User Video Call</h1>

    <h2>Local Video</h2>
    <video id="localVideo" autoplay muted playsinline></video>
    <p>Client ID: <span id="localClientId"></span></p>
    <p>Session ID: <span id="localSessionId"></span></p>
    <p>Track ID: <span id="localTrackId"></span></p>

    <h2>Remote Videos</h2>
    <div id="remoteVideos"></div>

    <script>
        const ws = new WebSocket('ws://localhost:3000'); // WebSocket connection
        let clientId;
        let sessionId;
        let trackId;
        const ROOM_ID = "default-room"; // Default Room for Multi-User

        // Store remote peer connections
        const peerConnections = {};

        ws.addEventListener('open', () => {
            console.log('[Client] ✅ WebSocket connected');
            clientId = generateClientId();
            document.getElementById('localClientId').textContent = clientId;
            startWebRTC();
        });

        ws.addEventListener('message', async (event) => {
            const message = JSON.parse(event.data);
            console.log(`[Client] ⬇️ Received: ${message.type}`, message);

            if (message.type === 'trackAdded') {
                sessionId = message.sessionId;
                document.getElementById('localSessionId').textContent = sessionId;
                trackId = message.response.tracks[0].trackName;
                document.getElementById('localTrackId').textContent = trackId;
                console.log(`[Client] 🔑 Cloudflare session created: ${sessionId}, Track: ${trackId}`);

            } else if (message.type === 'remoteClientConnected') {
                handleRemoteClient(message);
            } else if (message.type === 'error') {
                console.error(`[Client] ❌ Server Error: ${message.message}`);
            }
        });

        async function startWebRTC() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('localVideo').srcObject = stream;

                console.log(`[Client] 🎥 Local stream active.`);
                const peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
                });

                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const trackData = {
                    sessionDescription: { type: "offer", sdp: peerConnection.localDescription.sdp },
                    tracks: [{ location: "local", mid: "0", trackName: `local-track-${Date.now()}` }]
                };

                ws.send(JSON.stringify({
                    type: 'joinCall',
                    clientId: clientId,
                    trackData: trackData,
                    roomId: ROOM_ID
                }));

            } catch (error) {
                console.error(`[Client] ❌ Error:`, error);
            }
        }

        function handleRemoteClient(message) {
            const remoteClientId = message.clientId;
            const remoteSessionId = message.sessionId;

            console.log(`[Client] 🧑‍🤝‍🧑 New Remote Client: ${remoteClientId}, Session: ${remoteSessionId}`);

            if (!peerConnections[remoteClientId]) {
                const remoteVideo = document.createElement('video');
                remoteVideo.id = `video-${remoteClientId}`;
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                document.getElementById('remoteVideos').appendChild(remoteVideo);

                const peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
                });

                peerConnection.ontrack = (event) => {
                    if (event.streams.length > 0) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                };

                peerConnections[remoteClientId] = peerConnection;
            }
        }

        function generateClientId() {
            return Math.random().toString(36).substring(2, 15);
        }
    </script>
</body>
</html>
