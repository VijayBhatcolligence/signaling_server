<!DOCTYPE html>
<html>
<head>
    <title>Cloudflare WebRTC Test</title>
</head>
<body>
    <h1>Cloudflare WebRTC Test</h1>
    <button id="getSdpBtn">Generate Local SDP</button><br>
    <textarea id="localSdp" placeholder="Local SDP will appear here" rows="10" cols="50"></textarea><br>

    <video id="localVideo" autoplay muted></video>

    <script>
        const ws = new WebSocket('ws://localhost:3000'); // Replace if needed
        let clientId;
        let peerConnection;

        ws.addEventListener('open', () => {
            console.log('WebSocket connected');
            clientId = generateClientId();
            console.log(`Client ID: ${clientId}`);
        });

        ws.addEventListener('message', (event) => {
            const message = JSON.parse(event.data);
            console.log('Received:', message);

            if (message.type === 'sessionCreated') {
                console.log('session Created');
            } else if (message.type === 'trackAdded') {
                console.log('Audio track added successfully!', message.response);
            } else if (message.type === 'error') {
                console.error('Error:', message.message);
            }
        });

        ws.addEventListener('close', () => {
            console.log('WebSocket connection closed');
        });

        ws.addEventListener('error', (error) => {
            console.error('WebSocket error:', error);
        });

        document.getElementById('getSdpBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                document.getElementById('localVideo').srcObject = stream;

                console.log("getUserMedia succeeded. Stream:", stream);
                console.log("Number of tracks in stream:", stream.getTracks().length);

                peerConnection = new RTCPeerConnection({
                    iceServers: [
                      {
                        urls: [
                          'stun:stun.l.google.com:19302',
                          'stun:stun1.l.google.com:19302',
                        ],
                      },
                    ],
                  });
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const localSdp = peerConnection.localDescription.sdp;
                document.getElementById('localSdp').value = localSdp;
                console.log('Local SDP:', localSdp);
                const audioMid = "0";

                const trackData = {
                    sessionDescription: { // Explicitly include sessionDescription
                        type: "offer",
                        sdp: localSdp
                    },
                    tracks: [
                        {
                            location: "local",
                            mid: audioMid,
                            trackName: `local-audio-track-${Date.now()}`
                        }
                    ]
                };
                ws.send(JSON.stringify({ type: 'joinCall', clientId: clientId,trackData: trackData}));

            } catch (error) {
                console.error('Error generating SDP:', error);
                console.error("getUserMedia error:", error);
            }
        });



        function generateClientId() {
            return Math.random().toString(36).substring(2, 15);
        }


    </script>
</body>
</html>
