<!DOCTYPE html>
<html>

<head>
    <title>Cloudflare WebRTC Test</title>
</head>

<body>
    <h1>Cloudflare WebRTC Test</h1>

    <h2>Local Video</h2>
    <video id="localVideo" autoplay muted playsinline></video>
    <p>Client ID: <span id="localClientId"></span></p>
    <p>Session ID: <span id="localSessionId"></span></p>
    <p>Track ID: <span id="localTrackId"></span></p>

    <h2>Remote Video</h2>
    <div id="remoteVideo" autoplay playsinline></div>
    <p>Remote Client ID: <span id="remoteClientId"></span></p>
    <p>Remote Session ID: <span id="remoteSessionId"></span></p>
    <p>Remote Track ID: <span id="remoteTrackId"></span></p>

    <script>
        const ws = new WebSocket('ws://localhost:3000');
        let clientId;
        let peerConnection;
        let sessionId; // Store the Cloudflare session ID
        let trackId;
        const ROOM_ID = "default-room"; // Added Default Room

        ws.addEventListener('open', () => {
            console.log('WebSocket connected');
            clientId = generateClientId();
            document.getElementById('localClientId').textContent = clientId;
            console.log(`[Client] ‚úÖ WebSocket Connection opened. Client ID: ${clientId}`);
            startWebRTC();
        });

        ws.addEventListener('message', async (event) => {
            const message = JSON.parse(event.data);
            console.log(`[Client] ‚¨áÔ∏è Received message (Type: ${message.type}) from Server:`, message);

            if (message.type === 'trackAdded') {
                sessionId = message.sessionId; // Store the session ID
                document.getElementById('localSessionId').textContent = sessionId;
                console.log(`[Client] üîë Cloudflare session created. Session ID: ${sessionId}`);
            }  if (message.type === 'trackAdded') {
                console.log(`[Client] ‚úÖ Audio track added successfully! Response:`, message.response);
                trackId = message.response.tracks[0].trackName;
                document.getElementById('localTrackId').textContent = trackId;
            } else if (message.type === 'remoteClientConnected') {
                const remoteClientId = message.clientId;
                const remoteSessionId = message.sessionId;
                const remoteTrackData = message.trackData;

                document.getElementById('remoteClientId').textContent = remoteClientId;
                document.getElementById('remoteSessionId').textContent = remoteSessionId;
                 document.getElementById('remoteTrackId').textContent = remoteTrackData.tracks[0].trackName;

                console.log(`[Client] üßë‚Äçü§ù‚Äçüßë Remote client connected: ${remoteClientId}`);
                console.log(`[Client] üîë Remote client session ID: ${remoteSessionId}`);
                console.log(`[Client] üéµ Remote client track data:`, remoteTrackData);
            } else if (message.type === 'error') {
                console.error(`[Client] ‚ùå Error from Server: ${message.message}`);
            }
        });

        ws.addEventListener('close', () => {
            console.log(`[Client] üö™ WebSocket connection closed`);
        });

        ws.addEventListener('error', (error) => {
            console.error(`[Client] ‚ùå WebSocket error:`, error);
        });

        async function startWebRTC() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });
                document.getElementById('localVideo').srcObject = stream;

                console.log(`[Client] üé• getUserMedia succeeded. Local stream active.`);
                console.log(`[Client] üîä Number of tracks in stream: ${stream.getTracks().length}`);

                peerConnection = new RTCPeerConnection({
                    iceServers: [{
                        urls: [
                            'stun:stun.l.google.com:19302',
                            'stun:stun1.l.google.com:19302',
                        ],
                    }, ],
                });

                peerConnection.oniceconnectionstatechange = (event) => {
                    console.log(`[Client] ICE Connection State Change: ${peerConnection.iceConnectionState}`);
                };

                peerConnection.onconnectionstatechange = (event) => {
                    console.log(`[Client] Peer Connection State Change: ${peerConnection.connectionState}`);
                };

                peerConnection.ontrack = (event) => {
                    console.log(`[Client] ‚úÖ‚úÖ‚úÖ ontrack event fired!`);
                    console.log(`[Client] üé¨ Tracks in ontrack event:`, event.tracks);
                    console.log(`[Client] üåä Streams in ontrack event:`, event.streams);
                    const remoteVideo = document.getElementById('remoteVideo'); // Target the correct remote video element
                    if (event.streams && event.streams.length > 0) {
                        remoteVideo.srcObject = event.streams[0];
                        console.log(`[Client] üì∫ Remote video stream set!`);
                    } else {
                        console.warn(`[Client] No streams found in ontrack event!`);
                    }
                };

                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const localSdp = peerConnection.localDescription.sdp;
                const audioMid = "0";

                const trackData = {
                    sessionDescription: { // Explicitly include sessionDescription
                        type: "offer",
                        sdp: localSdp
                    },
                    tracks: [{
                        location: "local",
                        mid: audioMid,
                        trackName: `local-audio-track-${Date.now()}`
                    }]
                };
                const joinCallMessage = {
                    type: 'joinCall',
                    clientId: clientId,
                    trackData: trackData,
                    roomId: ROOM_ID // Send the room ID
                };
                console.log(`[Client] ‚¨ÜÔ∏è Sending joinCall message to Server:`, joinCallMessage);
                ws.send(JSON.stringify(joinCallMessage));
                console.log(`[Client] ‚¨ÜÔ∏è Join call message sent`);

            } catch (error) {
                console.error(`[Client] ‚ùå Error generating SDP:`, error);
                console.error(`[Client] ‚ùå getUserMedia error:`, error);
            }
        }

        function generateClientId() {
            return Math.random().toString(36).substring(2, 15);
        }
    </script>
</body>

</html>