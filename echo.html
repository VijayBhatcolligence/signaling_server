<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Multi-User Video Call</title>
</head>
<body>
    <h1>Multi-User Video Chat</h1>
    <video id="localVideo" autoplay playsinline></video>
    <div id="remoteVideos"></div>

    <script>
        const ws = new WebSocket('ws://localhost:3000');
        const localVideo = document.getElementById("localVideo");
        const remoteVideos = document.getElementById("remoteVideos");
        const roomId = "test-room";
        const clientId = Math.random().toString(36).substring(2, 8);
        let peerConnections = {};
        let localStream;

        // Get user media
        async function getLocalStream() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
        }

        ws.onopen = () => {
            console.log("[WebSocket] Connected");
            ws.send(JSON.stringify({ type: "joinCall", clientId, roomId }));
        };

        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            console.log("[WebSocket] Message:", message);

            if (message.type === 'remoteClientConnected') {
                setupPeerConnection(message.clientId);
            }

            if (message.type === 'offer') {
                await handleOffer(message.sdp, message.clientId);
            }

            if (message.type === 'answer') {
                await handleAnswer(message.sdp, message.clientId);
            }
        };

        function setupPeerConnection(remoteClientId) {
            if (peerConnections[remoteClientId]) return;
            
            const peerConnection = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate, targetClientId: remoteClientId }));
                }
            };

            peerConnection.ontrack = event => {
                let remoteVideo = document.getElementById(remoteClientId);
                if (!remoteVideo) {
                    remoteVideo = document.createElement("video");
                    remoteVideo.id = remoteClientId;
                    remoteVideo.autoplay = true;
                    remoteVideo.playsInline = true;
                    remoteVideos.appendChild(remoteVideo);
                }
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnections[remoteClientId] = peerConnection;

            createOffer(remoteClientId);
        }

        async function createOffer(targetClientId) {
            const peerConnection = peerConnections[targetClientId];
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp, targetClientId }));
        }

        async function handleOffer(sdp, senderId) {
            setupPeerConnection(senderId);
            const peerConnection = peerConnections[senderId];

            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: "offer", sdp }));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp, targetClientId: senderId }));
        }

        async function handleAnswer(sdp, senderId) {
            const peerConnection = peerConnections[senderId];
            await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: "answer", sdp }));
        }

        getLocalStream();
    </script>
</body>
</html>
